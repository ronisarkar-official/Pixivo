<% include ./partials/header.ejs %> <% const safePosts = Array.isArray(posts) ?
posts.slice() : []; const BATCH_SIZE = 20; const firstBatch = safePosts.slice(0,
BATCH_SIZE); const remaining = safePosts.slice(BATCH_SIZE); %>

<!-- Search Form (unchanged) -->
<div class="mb-8 static z-0">
	<div class="flex justify-center mt-4 static">
		<form
			action="/feed"
			method="GET"
			class="flex items-center bg-white/10 backdrop-blur-md border border-white/20 rounded-full px-4 py-2 w-full max-w-lg shadow-sm hover:shadow-md transition">
			<i class="ri-search-line text-white/70 text-lg"></i>
			<input
				type="text"
				name="q"
				value="<%= typeof q !== 'undefined' ? q : '' %>"
				placeholder="Search pins..."
				class="flex-1 px-3 bg-transparent text-white placeholder-white/50 focus:outline-none" />
		</form>
	</div>

	<% if (q) { %>
	<p class="mt-2 text-gray-400 text-center">
		Found <%= total %> <%= total === 1 ? 'result' : 'results' %> for "<%= q %>"
	</p>
	<% } %>
</div>

<div class="max-w-5xl mx-auto mt-10 px-4 sm:px-0">
	<div
		id="pinsColumn"
		class="columns-2 gap-4 space-y-4 mt-6 sm:columns-3 lg:columns-4">
		<% if (firstBatch.length > 0) { %> <% firstBatch.forEach((elem, idx) => { %>
		<!-- Pin card (exact same layout & data attributes) -->
		<a
			href="/pin/<%= elem._id %>"
			class="block break-inside-avoid overflow-hidden rounded-2xl transition-shadow duration-300">
			<div
				class="break-inside-avoid overflow-hidden rounded-2xl transition-shadow duration-300 cursor-pointer"
				data-image="<%= elem.image %>"
				data-title="<%= elem.imageTitle %>"
				data-desc="<%= elem.imageDesc || '' %>"
				data-index="<%= idx %>"
				data-author-fullname="<%= (elem.author && elem.author.fullname) || (elem.user && elem.user.fullname) || 'Unknown' %>"
				data-author-username="<%= (elem.author && elem.author.username) || (elem.user && elem.user.username) || '' %>"
				data-author-image="<%= (elem.author && elem.author.profileimage) || (elem.user && elem.user.profileimage) || 'defaultpic.jpg' %>">
				<img
					src="<%= elem.image %>"
					alt="<%= elem.imageTitle %>"
					class="w-full object-cover rounded-2xl pin-img"
					loading="lazy"
					decoding="async" />
				<% if (elem.imageTitle) { %>
				<div class="p-3 text-sm text-white"><%= elem.imageTitle %></div>
				<% } %>
			</div>
		</a>
		<% }) %> <% } else { %>
		<div class="col-span-full text-center py-8 md:py-0 px-4 md:px-0">
			<h3 class="text-lg md:text-xl font-medium text-gray-500">
				<% if (q) { %> No pins found for "<%= q %>" <% } else { %> No pins
				available yet <% } %>
			</h3>
			<% if (q) { %>
			<div class="mt-4 md:mt-3">
				<a
					href="/feed"
					class="text-blue-500 hover:underline inline-block md:mr-[9.5rem]"
					>View all pins</a
				>
			</div>
			<% } %>
		</div>
		<% } %>
	</div>

	<!-- sentinel used to trigger loading more batches -->
	<div
		id="pinsSentinel"
		class="h-8"></div>
</div>

<style>
	/* purely visual fade-in for images: doesn't affect layout */
	.pin-img {
		transition: opacity 0.36s ease, transform 0.36s ease;
		opacity: 0;
		transform: translateZ(0);
	}
	.pin-img.loaded {
		opacity: 1;
	}
</style>
<script src="/javascripts/feed.js"></script>
<% include ./partials/footer.ejs %>
