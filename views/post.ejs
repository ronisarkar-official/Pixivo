<%- include("partials/header.ejs") %> <% var author = (post && post.user) ?
post.user : {}; var relAll = Array.isArray(posts) ? posts : []; var excludeId =
(post && post._id) ? String(post._id) : null; var relatedUnfiltered = excludeId
? relAll.filter(function(p){ return String(p._id) !== excludeId; }) : relAll;
var passedRelatedLimit = (typeof locals !== 'undefined' && typeof
locals.relatedLimit !== 'undefined' && isFinite(Number(locals.relatedLimit))) ?
Number(locals.relatedLimit) : undefined; var relatedLimit = (typeof
passedRelatedLimit === 'number') ? passedRelatedLimit : 17; var related =
(relatedLimit > 0) ? relatedUnfiltered.slice(0, relatedLimit) :
relatedUnfiltered; var imgUrl = (post && post.image) ? post.image :
'/images/placeholder.png'; var imgAlt = (post && post.imageTitle) ?
post.imageTitle : 'Post image'; var title = (post && post.imageTitle) ?
post.imageTitle : 'Untitled'; var desc = (post && post.imageDesc) ?
post.imageDesc : ''; var likes = (post && Array.isArray(post.likes)) ?
post.likes.length : 0; var commentsCount = (post &&
Array.isArray(post.comments)) ? post.comments.length : 0; var authorImg =
(author && author.profileimage) ? author.profileimage :
'/images/defaultpic.png'; var authorName = (author && author.fullname) ?
author.fullname : 'Unknown'; var authorUsername = (author && author.username) ?
author.username : 'unknown'; var createdAt = (post && post.createdAt) ? new
Date(post.createdAt) : null; var safePostId = (post && post._id) ? post._id :
''; %>

<!-- Page wrapper -->
<main
	class="max-w-[1200px] mx-auto px-4 sm:px-6 lg:px-8 py-6 text-white"
	data-post-id="<%= safePostId %>"
	data-current-user='<%- (JSON.stringify(user || null) || "null").replace(/</g, "\\u003c") %>'>
	<!-- Top actions -->
	<div class="mb-4 flex items-center justify-between gap-3 z-[-1]">
		<a
			href="#"
			onclick="history.back(); return false;"
			class="inline-flex items-center gap-3 rounded-full px-4 py-2 text-sm font-medium bg-transparent border border-white/10 backdrop-blur-sm shadow-sm transition transform hover:bg-white/5 active:scale-95 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-white/30"
			aria-label="Go back">
			<svg
				xmlns="http://www.w3.org/2000/svg"
				class="w-4 h-4 -ml-0.5"
				viewBox="0 0 24 24"
				fill="none"
				stroke="currentColor"
				stroke-width="2"
				stroke-linecap="round"
				stroke-linejoin="round"
				aria-hidden="true">
				<path d="M15 18l-6-6 6-6"></path>
			</svg>
			<span>Back</span>
		</a>

		<div class="flex items-center gap-3">
			<div class="relative">
				<button
					id="shareBtn"
					aria-haspopup="true"
					aria-expanded="false"
					class="inline-flex items-center gap-2 px-3 py-2 rounded-full border border-white/10 text-sm hover:bg-white/5 transition focus-visible:ring-2 focus-visible:ring-white/20 cursor-pointer">
					<i
						class="ri-share-forward-line text-lg z-[-10]"
						aria-hidden="true"></i>
					<span class="hidden sm:inline">Share</span>
				</button>

				<!-- Dropdown for devices without Web Share API (hidden by default) -->
				<div
					id="shareMenu"
					class="hidden absolute right-0 mt-2 w-44 rounded-lg bg-[#0b1220] border border-white/10 shadow-2xl py-1 z-[-50]"
					role="menu"
					aria-label="Share menu">
					<button
						data-action="native"
						class="w-full text-left px-3 py-2 text-sm hover:bg-white/5 transition"
						role="menuitem"
						>Share via device</button
					>
					<button
						data-action="copy"
						class="w-full text-left px-3 py-2 text-sm hover:bg-white/5 transition"
						role="menuitem"
						>Copy link</button
					>
					<a
						href="<%= imgUrl %>"
						target="_blank"
						rel="noopener"
						class="block px-3 py-2 text-sm hover:bg-white/5 transition"
						role="menuitem"
						>Open image</a
					>
				</div>
			</div>

			<a
				href="<%= imgUrl %>"
				target="_blank"
				rel="noopener"
				class="inline-flex items-center gap-2 px-3 py-2 rounded-full border border-white/10 text-sm hover:bg-white/5 transition focus-visible:ring-2 focus-visible:ring-white/20">
				<i
					class="ri-external-link-line text-lg"
					aria-hidden="true"></i>
				<span class="hidden sm:inline">Open</span>
			</a>

			<a
				id="downloadBtn"
				href="<%= imgUrl %>"
				download
				class="inline-flex items-center gap-2 px-3 py-2 rounded-full bg-white/6 text-sm border border-white/8 hover:bg-white/8 transition focus-visible:ring-2 focus-visible:ring-white/20">
				<i
					class="ri-download-2-line text-lg"
					aria-hidden="true"></i>
				<span class="hidden sm:inline">Download</span>
			</a>
		</div>
	</div>

	<!-- Responsive 2-column layout -->
	<div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
		<!-- Left: Image -->
		<section class="lg:col-span-6">
			<div
				id="modalImageWrap"
				class="relative rounded-2xl overflow-hidden shadow-2xl border border-white/10 bg-gradient-to-b from-white/3 to-transparent">
				<!-- Image frame: uses aspect containment and friendly pinch props -->
				<div
					id="imageFrame"
					class="w-full flex items-center justify-center bg-transparent p-4 touch-action-pan-y"
					style="height: min(70vh, 800px)">
					<img
						id="modalImage"
						src="<%= imgUrl %>"
						alt="<%= imgAlt || title %>"
						fetchpriority="high"
						decoding="async"
						loading="eager"
						class="max-w-full max-h-full w-auto h-auto object-contain transition-transform duration-300 rounded-lg z-[-10]"
						tabindex="0" />
				</div>
			</div>

			<!-- Body -->
			<div
				class="rounded-2xl border border-white/10 bg-[#0f1720] p-4 space-y-6 mt-2">
				<header class="p-2 lg:top-15 z-30">
					<div class="flex items-center justify-between gap-4">
						<div class="flex items-center gap-3">
							<img
								src="<%= authorImg %>"
								alt="Author avatar"
								class="w-12 h-12 rounded-full object-cover border border-white/10" />
							<div>
								<div class="font-semibold text-sm leading-tight"
									><%= authorName %></div
								>
								<div class="text-xs text-white/70 leading-tight"
									>@<%= authorUsername %></div
								>
							</div>
						</div>
					</div>
					<audio
						id="like-sound"
						src="/sounds/like-sound.mp3"
						preload="auto"></audio>
				</header>
				<!-- Title & description (desktop) -->
				<div class="mt-3 lg:hidden">
					<div class="font-semibold text-base leading-tight"><%= title %></div>
					<% if (desc) { %>
					<p class="mt-1 text-sm text-white/80"><%= desc %></p>
					<% } %>
				</div>
				<div class="hidden lg:block">
					<h1 class="text-2xl font-extrabold leading-tight"><%= title %></h1>
					<% if (desc) { %>
					<p class="mt-2 text-base text-white/85 leading-relaxed"
						><%= desc %></p
					>
					<% } %>
				</div>

				<!-- Stats / Actions -->
				<div class="flex items-center justify-between text-white/85 text-sm">
					<div class="flex items-center gap-3">
						<button
							onclick="document.getElementById('like-sound').play()"
							id="likeBtn-<%= safePostId %>"
							class="group inline-flex items-center gap-2 rounded-full border border-white/10 px-3 py-1.5 hover:bg-white/5 transition cursor-pointer"
							aria-pressed="<%= (user && Array.isArray(post.likes) && post.likes.includes(user._id)) ? 'true' : 'false' %>">
							<i
								class="ri-heart-line"
								aria-hidden="true"></i>
							<i
								class="ri-heart-fill hidden"
								aria-hidden="true"></i>
							<span id="likeCount-<%= safePostId %>"><%= likes %></span>
						</button>

						<a
							href="#commentInput-<%= safePostId %>"
							class="inline-flex items-center gap-2 rounded-full border border-white/10 px-3 py-1.5 hover:bg-white/5 transition">
							<i
								class="ri-chat-1-line"
								aria-hidden="true"></i>
							<span id="commentCount-<%= safePostId %>"
								><%= commentsCount %></span
							>
						</a>
					</div>

					<div class="text-xs text-white/60"
						>Posted <%= createdAt ? createdAt.toLocaleDateString() : new
						Date(post.createdAt || post.created_at ||
						Date.now()).toLocaleDateString() %></div
					>
				</div>

				<!-- Comment input -->
				<div>
					<label
						for="commentInput-<%= safePostId %>"
						class="text-xs text-white/70"
						>Add a comment</label
					>
					<div class="mt-2 flex items-center gap-2">
						<input
							id="commentInput-<%= safePostId %>"
							type="text"
							placeholder="Add a commentâ€¦"
							class="flex-1 px-4 py-2 rounded-full bg-white/5 border border-white/10 text-sm outline-none focus:ring-2 focus:ring-white/10"
							aria-label="Add a comment" />
						<button
							id="postComment-<%= safePostId %>"
							class="cursor-pointer px-4 py-2 rounded-full bg-green-600 hover:bg-green-700 text-white text-sm"
							>Post</button
						>
					</div>

					<ul
						id="commentList-<%= safePostId %>"
						class="scrollarea mt-3 flex flex-col space-y-2 max-h-48 overflow-y-auto">
						<% (Array.isArray(post.comments) ? post.comments : [])
						.slice().reverse().forEach(c => { %>
						<li class="flex items-start gap-3 p-2">
							<img
								src="<%= (c.user && c.user.profileimage) ? c.user.profileimage : '/images/defaultpic.png' %>"
								alt="avatar"
								class="w-9 h-9 rounded-full object-cover" />
							<div class="flex-1">
								<p
									class="text-sm text-white leading-relaxed break-words flex items-center gap-2">
									<span class="font-semibold text-white">
										<%= (c.user && c.user.username) ? c.user.username :
										'Unknown' %>
									</span>
									<span class="text-xs text-white/50">
										<%= c.createdAt ? timeAgo(c.createdAt) : '' %>
									</span>
								</p>
								<span class="ml-2 text-white/90"><%= c.text %></span>
							</div>
						</li>
						<% }) %>
					</ul>
				</div>
			</div>

			<!-- More like this (masonry) -->
			<section class="mt-6 w-full">
				<% function shuffleArray(arr) { const a = Array.isArray(arr) ?
				arr.slice() : []; for (let i = a.length - 1; i > 0; i--) { const j =
				Math.floor(Math.random() * (i + 1)); const tmp = a[i]; a[i] = a[j]; a[j]
				= tmp; } return a; } const shuffledMain = shuffleArray(related || []);
				%>

				<div
					id="relatedGridMain"
					class="masonry-grid grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-2 xl:grid-cols-2 gap-4">
					<% shuffledMain.forEach((p) => { %>
					<a
						href="/pin/<%= p._id %>"
						class="masonry-item block">
						<!-- Fully rounded image -->
						<div
							class="thumb w-full h-44 sm:h-36 md:h-44 lg:h-40 overflow-hidden">
							<img
								src="<%= p.image %>"
								alt="<%= p.imageTitle || 'Related image' %>"
								loading="lazy"
								decoding="async"
								referrerpolicy="no-referrer"
								class="w-full h-full object-cover block rounded-2xl" />
						</div>

						<!-- Title below image -->
						<% if (p.imageTitle) { %>
						<div class="text-xs text-white/80 font-medium truncate px-2">
							<%= p.imageTitle %>
						</div>
						<% } %>
					</a>
					<% }) %>
				</div>
			</section>

			<!-- caption / meta (mobile) -->
		</section>

		<!-- Right: Info Panel -->
		<aside class="lg:col-span-6 flex flex-col gap-6">
			<!-- sticky header on large screens -->
			<% function shuffleArray(arr) { const a = Array.isArray(arr) ? arr.slice()
			: []; for (let i = a.length - 1; i > 0; i--) { const j =
			Math.floor(Math.random() * (i + 1)); const tmp = a[i]; a[i] = a[j]; a[j] =
			tmp; } return a; } const shuffledRelated = shuffleArray(related || []); %>

			<section class="w-full p-1">
				<div
					id="relatedGridAside"
					class="masonry-grid grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-2 xl:grid-cols-2 gap-8 mb-4">
					<% shuffledRelated.forEach((p) => { %>
					<a
						href="/pin/<%= p._id %>"
						class="masonry-item block"
						data-id="<%= p._id %>">
						<!-- Fully rounded image -->
						<div class="thumb w-full h-28 overflow-hidden gap-2">
							<img
								src="<%= p.image %>"
								alt="<%= p.imageTitle || 'Related image' %>"
								loading="lazy"
								decoding="async"
								referrerpolicy="no-referrer"
								class="w-full h-full object-cover block rounded-2xl" />
						</div>

						<!-- Title below image -->
						<% if (p.imageTitle) { %>
						<div class="text-xs text-white/80 font-medium truncate px-2">
							<%= p.imageTitle %>
						</div>
						<% } %>
					</a>
					<% }) %>
				</div>
			</section>
		</aside>
	</div>
	<!-- end two-column -->
</main>

<!-- Tiny toast -->
<div
	id="toast"
	class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden px-3 py-2 rounded-full text-sm bg-black/80 border border-white/10 z-40"></div>

<style>
	/* Accessibility: stronger focus */
	a:focus,
	button:focus {
		outline: 3px solid rgba(255, 255, 255, 0.08);
		outline-offset: 2px;
	}

	/* Masonry helper: grid baseline rows */
	.masonry-grid {
		display: grid;
		grid-auto-rows: 8px; /* small baseline used by JS */
		gap: 1rem; /* match Tailwind gap-4 */
	}

	/* Make each masonry item auto-size by spanning rows (JS sets grid-row-end) */
	.masonry-item {
		break-inside: avoid;
		-webkit-column-break-inside: avoid;
		-moz-column-break-inside: avoid;
		align-self: start;
	}

	.masonry-item .thumb {
		width: 100%;
		height: 100%;
		overflow: hidden;
		display: block;
	}

	.masonry-item img {
		display: block;
		width: 100%;
		height: 100%;
		object-fit: cover;
	}

	/* Make the image visually smooth when zoom toggled */
	#modalImage {
		transition: transform 240ms cubic-bezier(0.2, 0.8, 0.2, 1);
	}

	/* friendly pinch/zoom */
	#imageFrame {
		touch-action: pan-y pinch-zoom;
	}

	/* small screens: reduce gaps */
	@media (max-width: 640px) {
		.masonry-grid {
			gap: 10px;
		}
	}

	.commentList {
		overflow: auto; /* enable scrolling */
		scrollbar-width: none; /* Firefox */
	}

	.commentList::-webkit-scrollbar {
		display: none; /* Chrome, Safari, Edge */
	}

	/* Firefox */
	.scrollarea {
		scrollbar-width: thin;
		scrollbar-color: #000 transparent;
	}
	/* Chrome, Edge, Safari */
	.scrollarea::-webkit-scrollbar {
		width: 6px;
	}
	.scrollarea::-webkit-scrollbar-track {
		background: transparent;
	}
	.scrollarea::-webkit-scrollbar-thumb {
		background: #000;
		border-radius: 6px;
	}
</style>
<script></script>
<script src="/javascripts/postscript.js"></script>

<%- include("partials/footer.ejs") %>
